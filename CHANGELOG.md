# Changelog

All notable changes to Stack Tracker are documented in this file.

## [Unreleased]

### Added
- Next.js App Router MVP scaffold with public pages:
  - Homepage (`/`) with floating nav, hero, top-five cards, vendor tables.
  - Peptide detail template (`/peptides/[slug]`) with trend chart, variant switching, and pagination.
- Admin surface and workflows:
  - Magic-link auth endpoints and admin pages.
  - Review queue resolution actions.
  - Featured compounds management.
  - Vendor aggressive re-scrape queue.
- Public API endpoints:
  - `GET /api/home`
  - `GET /api/compounds/:slug`
  - `GET /api/compounds/:slug/offers`
  - `GET /api/compounds/:slug/trend`
- Internal job endpoints:
  - `GET|POST /api/internal/jobs/vendors`
  - `GET|POST /api/internal/jobs/finnrick`
- Scraping and normalization pipeline:
  - Rules-first alias matching with confidence.
  - Formulation-aware parsing and metric computation.
  - Offer history/versioning behavior for unchanged vs changed records.
  - Safe-mode robots handling + AI-agent fallback task queue.
- Data model and SQL:
  - Full schema in `sql/schema.sql`.
  - Seed data in `sql/seed.sql` including initial three vendor URLs.
- Operations and tooling:
  - `npm run db:bootstrap` to apply schema + seed without direct `psql` usage.
  - Job scripts load `.env.local` via `--env-file-if-exists`.
  - Vercel cron configuration in `vercel.json`.
- Documentation:
  - Product requirements in `PRD.md`.
  - Handoff/restart instructions in `HANDOFF.md`.
  - Updated runbook in `README.md`.
  - Vendor onboarding notes for US-direct-storefront scope and platform/API verification.
- Category browsing routes:
  - `GET /categories`
  - `GET /categories/:slug`
- Vendor offering route:
  - `GET /vendors/:slug`
- Admin category management API:
  - `POST /api/admin/categories`
- Vendor audit utility script:
  - `scripts/finnrick-vendor-audit.js` for Finnrick vendor extraction, filtering, website discovery, platform detection, and API probing.
- DB maintenance script:
  - `sql/maintenance/cleanup-legacy-peptides.sql` for safe cleanup of legacy `public.peptides` table (preflight, backup, dependency checks, guarded drop).
- Category import script:
  - `scripts/import-compound-categories.ts` plus `npm run db:import-categories` for curated category upsert/mapping with multi-category support.
  - Import flow now seeds missing compounds from the curated taxonomy list before mapping.
- Regression tests for category behavior:
  - `tests/unit/category-queries.test.ts` validates active-variant guards in category DB queries.
  - `tests/unit/categories-page.test.ts` validates `/categories` metric fallback/preservation and category link rendering.
- Alias normalization regression tests:
  - `tests/unit/alias-normalize.test.ts` validates descriptor stripping for dosage/formulation suffixes while preserving ambiguous blend terms.
  - Expanded coverage now validates storefront-noise stripping, blend/stack detection, retatrutide shorthand inference, and non-product listing detection.
- HTML extraction regression test:
  - `tests/unit/extractors.test.ts` now validates Inertia `data-page` extraction for product+variant payloads.
- Product-name normalization regression test:
  - `tests/unit/normalize.test.ts` now validates storefront-noise stripping during inferred alias extraction.
- Discovery/runtime regression tests:
  - `tests/unit/discovery.test.ts` now validates per-origin API cache reuse and unsupported-origin memoization.
  - `tests/unit/worker-alerts.test.ts` validates batched alias-alert HTML formatting/truncation.

### Changed
- Floating nav category selector now routes to category pages before compound selection.
- Admin home now shows active compounds missing a primary category assignment.
- Peptide vendor-name links now route internally to vendor catalog pages, with external offer links retained.
- Added admin category editor workflow with multi-category and primary-category assignment controls.
- Vendor catalog page now shows simplified "Last updated" time in user locale with UTC fallback.
- Category import flow now seeds curated taxonomy compounds and supports split multi-category mappings (e.g., `Longevity / Mitochondrial`).
- Improved environment handling for local and production-first setup:
  - Added `DATABASE_PREPARE` toggle.
  - Documented Supabase/Vercel-first deployment path.
- Hardened parsing logic for capsule plural detection (`capsules`).
- Discovery strategy is now explicitly API-first with a documented vendor onboarding flow:
  - Prioritize WooCommerce Store API and Shopify public product feeds.
  - Restrict target list to US-facing direct storefront vendors.
  - Treat contact-to-order and non-storefront domains as excluded.
- Vendor onboarding verification log expanded with latest batch outcomes:
  - Additional Woo/Shopify/Wix storefront URLs confirmed.
  - Clinic-based, closed, and domain-for-sale providers explicitly marked excluded in docs.
  - Follow-up list documented for unresolved vendor URLs.
- Bootstrap schema now explicitly creates the one-primary-category partial unique index:
  - `compound_category_map_one_primary_per_compound`.
- Category browsing query behavior now aligns with selector behavior by requiring active variants.
- Admin category editor save workflow now catches network/fetch failures and surfaces an explicit row-level error.
- HTML discovery now parses Inertia `#app[data-page]` payloads and converts embedded product/variant records into offers (fixes coverage gaps on custom storefronts like `eliteresearchusa.com`).
- Alias resolution now attempts deterministic stripped-name matching (removing dosage/formulation descriptors like `10mg`, `vial`, `capsules`) before falling back to AI/review, improving auto-match coverage when base compounds already exist.
- Alias normalization now strips storefront noise (for example prices and CTA fragments like `add to cart`) before deterministic and AI matching.
- Blend/stack and non-product listing aliases are auto-skipped for single-compound tracking integrity.
- Added deterministic retatrutide shorthand fallback matching (`RT`, `GLP-3`, `NG-1 RT` context) to reduce avoidable review queue load.
- Vendor seed targets now include `https://eliteresearchusa.com/products` in addition to the site root.
- Runtime/docs now clarify Codex execution requirement for networked jobs: restricted sandbox can produce false DNS `ENOTFOUND`, full-access mode resolves this without app-code changes.
- Vendor scrape runtime now batches unresolved-alias admin alerts per page (instead of per alias) and wraps alert delivery with a timeout guard to prevent ingestion stalls.
- Discovery now caches Woo/Shopify API results per origin and records source-origin reuse; duplicate API-origin pages in the same run skip redundant offer persistence.
- Vendor cron cadence was updated from every 6 hours to every 24 hours (`vercel.json` now schedules `/api/internal/jobs/vendors` daily at `00:00` UTC).
- Vendor scrape runtime now emits page-level progress logs (start/completion + per-page deltas) so long-running runs remain observable in stdout.
- Peptide detail hero subhead now includes live coverage counts (`vendors` and `variations`) for the current compound.
- `scrape_runs` now stores `heartbeat_at` and jobs maintain heartbeat updates while running.
- Added stale-run reconciliation for scrape jobs: aged `running` runs are marked `failed` after TTL at job start.
- Added lag-alert events/email when heartbeat inactivity exceeds configured threshold.
- Vendor scrape worker now uses bounded page concurrency (`VENDOR_SCRAPE_CONCURRENCY`, default `2`, max `3`).
- Added optional runtime controls in env (`VENDOR_SCRAPE_CONCURRENCY`, `SCRAPE_RUN_STALE_TTL_MINUTES`, `SCRAPE_RUN_HEARTBEAT_SECONDS`, `SCRAPE_RUN_LAG_ALERT_SECONDS`).
- `job:review-ai` now emits queue progress logging for large scans.
  - Progress logs now include elapsed time, processing rate, ETA, and last outcome/reason context.
- Added automated operational-noise retention pruning in vendor runs:
  - Deletes aged `review_queue` rows with `status in ('resolved','ignored')` after `REVIEW_QUEUE_RETENTION_DAYS` (default `45`).
  - Deletes aged non-trackable alias memory (`compound_aliases` where `compound_id is null` and `status='resolved'`) after `NON_TRACKABLE_ALIAS_RETENTION_DAYS` (default `120`).

### Verified
- Passing checks under Node 20:
  - `npm run typecheck`
  - `npm run lint`
  - `npm run test`
- Verified networked ingestion execution in full-access mode:
  - `npm run job:vendors` succeeded (`scrapeRunId=ddf17efd-d5b7-48e9-abf3-4c601eea872f`, `pagesSuccess=10`, `pagesFailed=0`, `unresolvedAliases=90`, `offersUnchanged=86`).
  - `npm run job:finnrick` succeeded (`scrapeRunId=13073ab4-1f9b-498e-8c81-5130b0c35333`).
- Verified alias triage throughput run:
  - `npm run job:review-ai` completed on `2026-02-15` with `itemsScanned=580`, `resolved=64`, `ignored=0`, `leftOpen=516`, `real=420.01s`.
  - Observed throughput: `82.86 items/min` (`~0.72s/item`), which is faster than the planning estimate (`~1.5s/item`) without code changes.
  - Post-run `alias_match` queue totals: `open=516`, `in_progress=0`, `resolved=187`, `ignored=0`.
- Verified post-key queue burn-down slices:
  - Three 25-item slices after enabling `OPENAI_API_KEY`: `resolved=31`, `ignored=39`, `leftOpen=5`.
  - Queue totals moved from `open=516` to `open=446` (`resolved=218`, `ignored=39`, `in_progress=0`).

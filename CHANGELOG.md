# Changelog

All notable changes to Stack Tracker are documented in this file.

## [Unreleased]

### Added
- Next.js App Router MVP scaffold with public pages:
  - Homepage (`/`) with floating nav, hero, top-five cards, vendor tables.
  - Peptide detail template (`/peptides/[slug]`) with trend chart, variant switching, and pagination.
- Admin surface and workflows:
  - Magic-link auth endpoints and admin pages.
  - Review queue resolution actions.
  - Featured compounds management.
  - Vendor aggressive re-scrape queue.
- Public API endpoints:
  - `GET /api/home`
  - `GET /api/compounds/:slug`
  - `GET /api/compounds/:slug/offers`
  - `GET /api/compounds/:slug/trend`
- Internal job endpoints:
  - `GET|POST /api/internal/jobs/vendors`
  - `GET|POST /api/internal/jobs/finnrick`
- Scraping and normalization pipeline:
  - Rules-first alias matching with confidence.
  - Formulation-aware parsing and metric computation.
  - Offer history/versioning behavior for unchanged vs changed records.
  - Safe-mode robots handling + AI-agent fallback task queue.
- Data model and SQL:
  - Full schema in `sql/schema.sql`.
  - Seed data in `sql/seed.sql` including initial three vendor URLs.
  - Seed expansion now includes three vetted storefront batches (30 active vendors / 38 active vendor pages total).
- Operations and tooling:
  - `npm run db:bootstrap` to apply schema + seed without direct `psql` usage.
  - Job scripts load `.env.local` via `--env-file-if-exists`.
  - Vercel cron configuration in `vercel.json`.
- Documentation:
  - Product requirements in `PRD.md`.
  - Handoff/restart instructions in `HANDOFF.md`.
  - Updated runbook in `README.md`.
  - Vendor onboarding notes for US-direct-storefront scope and platform/API verification.
- Category browsing routes:
  - `GET /categories`
  - `GET /categories/:slug`
- Vendor offering route:
  - `GET /vendors/:slug`
- Admin category management API:
  - `POST /api/admin/categories`
- Vendor audit utility script:
  - `scripts/finnrick-vendor-audit.js` for Finnrick vendor extraction, filtering, website discovery, platform detection, and API probing.
- Single-vendor exclusion audit utility:
  - `scripts/run-single-vendor-exclusion-audit.ts` plus `npm run job:exclusion-audit`.
  - Produces report-only JSON/Markdown snapshots in `reports/exclusion-audit/` and marks every candidate as manual-confirmation-required (no automatic exclusion enforcement).
- Single-vendor exclusion enforcement utility:
  - `scripts/run-single-vendor-exclusion-enforcement.ts` plus `npm run job:exclusion-enforce`.
  - Compiles only reviewer-approved exclusions (`manualDecision.status='approved_exclusion'`) into `config/manual-offer-exclusions.json`.
- DB maintenance script:
  - `sql/maintenance/cleanup-legacy-peptides.sql` for safe cleanup of legacy `public.peptides` table (preflight, backup, dependency checks, guarded drop).
- Category import script:
  - `scripts/import-compound-categories.ts` plus `npm run db:import-categories` for curated category upsert/mapping with multi-category support.
  - Import flow now seeds missing compounds from the curated taxonomy list before mapping.
- Regression tests for category behavior:
  - `tests/unit/category-queries.test.ts` validates active-variant guards in category DB queries.
  - `tests/unit/categories-page.test.ts` validates `/categories` metric fallback/preservation and category link rendering.
- Alias normalization regression tests:
  - `tests/unit/alias-normalize.test.ts` validates descriptor stripping for dosage/formulation suffixes while preserving ambiguous blend terms.
  - Expanded coverage now validates storefront-noise stripping, blend/stack detection, retatrutide shorthand inference, and non-product listing detection.
- HTML extraction regression test:
  - `tests/unit/extractors.test.ts` now validates Inertia `data-page` extraction for product+variant payloads.
- Product-name normalization regression test:
  - `tests/unit/normalize.test.ts` now validates storefront-noise stripping during inferred alias extraction.
- Discovery/runtime regression tests:
  - `tests/unit/discovery.test.ts` now validates per-origin API cache reuse and unsupported-origin memoization.
  - `tests/unit/worker-alerts.test.ts` validates batched alias-alert HTML formatting/truncation.
- Expanded alias regression coverage:
  - `tests/unit/alias-normalize.test.ts` now validates additional tirzepatide shorthand variants (`GLP2-T`, `GLP-2TZ`, `GLP1-T`, `GLP-2 (T)`), CJC no-DAC Mod-GRF phrasing, and new cosmetic/non-product patterns.
  - `tests/unit/alias-normalize.test.ts` now also validates canonical numeric-token preservation (`BPC-157` dosage-choice tails) and batch-note/kit storefront-noise stripping (`Current batch tested at ...`, `Air Dispersal Kit`).
- Expanded-run robustness report:
  - `reports/robustness/expanded-vendor-robustness-2026-02-16.md` with per-vendor ingest/alias metrics, queue deltas, and zero-offer diagnostics.

### Changed
- Floating nav category selector now routes to category pages before compound selection.
- Admin home now shows active compounds missing a primary category assignment.
- Peptide vendor-name links now route internally to vendor catalog pages, with external offer links retained.
- Added admin category editor workflow with multi-category and primary-category assignment controls.
- Vendor catalog page now shows simplified "Last updated" time in user locale with UTC fallback.
- Category import flow now seeds curated taxonomy compounds and supports split multi-category mappings (e.g., `Longevity / Mitochondrial`).
- Improved environment handling for local and production-first setup:
  - Added `DATABASE_PREPARE` toggle.
  - Documented Supabase/Vercel-first deployment path.
- Hardened parsing logic for capsule plural detection (`capsules`).
- Discovery strategy is now explicitly API-first with a documented vendor onboarding flow:
  - Prioritize WooCommerce Store API and Shopify public product feeds.
  - Restrict target list to US-facing direct storefront vendors.
  - Treat contact-to-order and non-storefront domains as excluded.
- Vendor onboarding verification log expanded with latest batch outcomes:
  - Additional Woo/Shopify/Wix storefront URLs confirmed.
  - Clinic-based, closed, and domain-for-sale providers explicitly marked excluded in docs.
  - Follow-up list documented for unresolved vendor URLs.
- Bootstrap schema now explicitly creates the one-primary-category partial unique index:
  - `compound_category_map_one_primary_per_compound`.
- Category browsing query behavior now aligns with selector behavior by requiring active variants.
- Admin category editor save workflow now catches network/fetch failures and surfaces an explicit row-level error.
- HTML discovery now parses Inertia `#app[data-page]` payloads and converts embedded product/variant records into offers (fixes coverage gaps on custom storefronts like `eliteresearchusa.com`).
- Alias resolution now attempts deterministic stripped-name matching (removing dosage/formulation descriptors like `10mg`, `vial`, `capsules`) before falling back to AI/review, improving auto-match coverage when base compounds already exist.
- Alias normalization now strips storefront noise (for example prices and CTA fragments like `add to cart`) before deterministic and AI matching.
- Blend/stack and non-product listing aliases are auto-skipped for single-compound tracking integrity.
- Added deterministic retatrutide shorthand fallback matching (`RT`, `GLP-3`, `NG-1 RT` context) to reduce avoidable review queue load.
- Added deterministic shorthand fallback matching for:
  - Tirzepatide (`TZ`, `tirz`, `GLP-1 TZ`, `NG-TZ`, `ER-TZ` context).
  - Cagrilintide (`Cag`, `Cagrilinitide` misspelling context).
- Tirzepatide shorthand matching now also covers `GLP2-T`, `GLP-2TZ`, `GLP1-T`, and parenthesized `GLP-2 (T)` forms.
- Added deterministic semaglutide shorthand matching for `GLP1-S`, `GLP-1 (S)`, and `GLP1`.
- Added deterministic single-letter GLP shorthand matching for dose-coded aliases:
  - `R ... mg` -> `retatrutide`
  - `S ... mg` -> `semaglutide`
  - `T ... mg` -> `tirzepatide`
- Added regression guards for single-letter GLP shorthand so no-unit/non-`mg` forms (for example `R 30`, `S 10mcg`, `T 60mcg`) do not auto-match.
- Added deterministic CJC-with-DAC alias normalization guard and HTML-entity stripping so titles like `CJC-1295 &#8211; With DAC (10mg)` resolve safely.
- Added deterministic CJC no-DAC alias normalization for Mod-GRF phrasing (for example `CJC-1295 no DAC ... (Mod GRF 1-29)`).
- Added deterministic mapping for cosmetic peptide aliases:
  - `Acetyl Hexapeptide-8 (Argireline)` -> `argireline`
  - `Pal Tetrapeptide-7 (Matrixyl 3000)` -> `pal-tetrapeptide-7`
- Alias descriptor stripping now removes generic `peptide` suffixes and pack-count descriptor tails (for example `10 vials`) before deterministic matching.
- Alias descriptor stripping now preserves canonical numeric identity tokens while still removing dosage-choice tails (for example `BPC-157 Peptide 5mg/10mg/20mg` -> `bpc 157`).
- Storefront-noise stripping now removes batch-note and kit phrasing (`Current batch tested at ...`, `with Air Dispersal Kit`) before deterministic/AI matching.
- Expanded curated taxonomy seeds/mappings to include `Tirzepatide`, `Cagrilintide`, and `LL-37` canonical coverage.
- Vendor seed targets now include `https://eliteresearchusa.com/products` in addition to the site root.
- Vendor seed targets now include the first 10-vendor expansion batch from the vetted storefront list in `README.md`.
- Vendor seed targets now include a second vetted 5-vendor expansion batch from the same vetted storefront list:
  - `https://evolvebiopep.com/`
  - `https://purapeptides.com/`
  - `https://nusciencepeptides.com/`
  - `https://peptides4research.com/`
  - `https://atomiklabz.com/`
- Vendor seed targets now include a third vetted 12-vendor expansion batch from the same vetted storefront list:
  - `https://peptiatlas.com/`
  - `https://purerawz.co/`
  - `https://peptidecrafters.com/`
  - `https://biolongevitylabs.com/`
  - `https://lotilabs.com/`
  - `https://nexaph.com/`
  - `https://erospeptides.com/`
  - `https://www.biopepz.net/`
  - `https://purepeps.com/`
  - `https://hkroids.com/`
  - `https://reta-peptide.com/`
  - `https://swisschems.is/`
- Compound seed set now includes additional legitimate compounds discovered during expansion triage (including `semaglutide`, `cagrisema`, `thymalin`, `mazdutide`, `survodutide`, and related canonicals).
- Runtime/docs now clarify Codex execution requirement for networked jobs: restricted sandbox can produce false DNS `ENOTFOUND`, full-access mode resolves this without app-code changes.
- Vendor scrape runtime now batches unresolved-alias admin alerts per page (instead of per alias) and wraps alert delivery with a timeout guard to prevent ingestion stalls.
- Discovery now caches Woo/Shopify API results per origin and records source-origin reuse; duplicate API-origin pages in the same run skip redundant offer persistence.
- Vendor cron cadence was updated from every 6 hours to every 24 hours (`vercel.json` now schedules `/api/internal/jobs/vendors` daily at `00:00` UTC).
- Vendor scrape runtime now emits page-level progress logs (start/completion + per-page deltas) so long-running runs remain observable in stdout.
- Peptide detail hero subhead now includes live coverage counts (`vendors` and `variations`) for the current compound.
- `scrape_runs` now stores `heartbeat_at` and jobs maintain heartbeat updates while running.
- Added stale-run reconciliation for scrape jobs: aged `running` runs are marked `failed` after TTL at job start.
- Added lag-alert events/email when heartbeat inactivity exceeds configured threshold.
- Vendor scrape worker now uses bounded page concurrency (`VENDOR_SCRAPE_CONCURRENCY`, default `2`, max `3`).
- Discovery probing remains fallback-ordered per page (`WooCommerce API -> Shopify API -> HTML -> Firecrawl`) as an intentional rate-limit/reliability tradeoff while page workers run in parallel.
- Added optional runtime controls in env (`VENDOR_SCRAPE_CONCURRENCY`, `SCRAPE_RUN_STALE_TTL_MINUTES`, `SCRAPE_RUN_HEARTBEAT_SECONDS`, `SCRAPE_RUN_LAG_ALERT_SECONDS`).
- `job:review-ai` now emits queue progress logging for large scans.
  - Progress logs now include elapsed time, processing rate, ETA, and last outcome/reason context.
- `job:review-ai` now supports bounded queue slices via `--limit=<N>` (or `REVIEW_AI_LIMIT`) for cost-controlled triage runs.
- Non-trackable supplement aliases with `pre-workout` phrasing are now deterministically auto-ignored to reduce repeated unresolved queue items.
- Non-product heuristic coverage now includes cosmetic/noise patterns seen in expansion runs (for example dissolving strips, body cream, hair-growth formulations, conditioner, eye-glow, t-shirt).
- Added automated operational-noise retention pruning in vendor runs:
  - Deletes aged `review_queue` rows with `status in ('resolved','ignored')` after `REVIEW_QUEUE_RETENTION_DAYS` (default `45`).
  - Deletes aged non-trackable alias memory (`compound_aliases` where `compound_id is null` and `status='resolved'`) after `NON_TRACKABLE_ALIAS_RETENTION_DAYS` (default `120`).
- Vendor ingestion now supports manual exclusion-rule enforcement by exact product URL:
  - Loads active rules from `config/manual-offer-exclusions.json`.
  - Skips persisting matching offers (`OFFER_EXCLUDED_RULE`) and deactivates existing rows for those URLs.
- AI classifier fallback reliability was hardened:
  - Long `reason` outputs no longer fail local parsing (truncated safely to 200 chars).
  - Chat-completions fallback removed unsupported `temperature=0` for `gpt-5-mini`.
- `job:review-ai` now refreshes payload metadata for items left open after triage:
  - Updates reason/confidence and triage timestamp so unresolved reason-group reporting reflects current classification outcomes.
- Cached alias handling for `needs_review` entries now re-checks deterministic rules before returning `ai_review_cached`, enabling queue burn-down without repeated AI calls when heuristics improve.
- Deterministic blend/stack skip path is now constrained to explicit blend markers to reduce false-ignore risk from dosage-option slash notation.

### Verified
- Passing checks under Node 20:
  - `npm run typecheck`
  - `npm run lint`
  - `npm run test`
- Verified networked ingestion execution in full-access mode:
  - Expanded run (third onboarding pass): `npm run job:vendors` completed with `scrapeRunId=9b1960c1-9db9-467e-b477-eba428770954` (`status=partial`, `pagesTotal=38`, `pagesSuccess=32`, `pagesFailed=6`, `offersCreated=347`, `offersUpdated=1`, `offersUnchanged=766`, `unresolvedAliases=69`, `aliasesSkippedByAi=543`).
  - Expanded run (second onboarding pass): `npm run job:vendors` completed with `scrapeRunId=37c41def-d773-4d16-9556-4d45d5902a3f` (`status=partial`, `pagesTotal=26`, `pagesSuccess=25`, `pagesFailed=1`, `offersCreated=274`, `offersUpdated=1`, `offersUnchanged=537`, `unresolvedAliases=16`, `aliasesSkippedByAi=339`).
  - Expanded run: `npm run job:vendors` completed with `scrapeRunId=d515a861-ad68-4d28-9155-d2439bfe0f4a` (`status=partial`, `pagesTotal=21`, `pagesSuccess=20`, `pagesFailed=1`, `offersCreated=425`, `offersUnchanged=116`, `unresolvedAliases=73`, `aliasesSkippedByAi=231`).
  - Expanded run: `npm run job:finnrick` succeeded with `scrapeRunId=5233e9be-24fb-42ba-9084-2e8dde507589` (`vendorsTotal=13`, `vendorsMatched=10`, `ratingsUpdated=10`, `notFound=3`).
  - `npm run job:vendors` succeeded (`scrapeRunId=3178fe72-36db-4335-8fff-1b3fe6ec640a`, `pagesSuccess=10`, `pagesFailed=0`, `unresolvedAliases=0`, `offersUnchanged=116`, `offersExcludedByRule=0`).
  - `npm run job:finnrick` succeeded (`scrapeRunId=8a108444-b26a-4f2a-94a9-347cc970a140`).
- Verified expansion-cycle triage delta:
  - Intermediate triage moved queue from `open=73`, `resolved=384`, `ignored=333` (post-vendor-run) to `open=43`, `resolved=396`, `ignored=351`.
  - Intermediate delta: `open -30`, `resolved +12`, `ignored +18`.
  - One bounded triage attempt failed with `canceling statement due to statement timeout`; subsequent reruns completed.
  - Final follow-up triage + taxonomy onboarding closed the queue: `open=0`, `resolved=437`, `ignored=353`.
  - Second expansion-cycle triage closed reopened queue `open=16` -> `open=0` with final totals `resolved=440`, `ignored=366`.
  - Second-pass triage detail: first bounded run left all `16` open (`ai_review_cached`), deterministic normalization fixes resolved `3`, and manual adjudication ignored the final `13` branded/ambiguous aliases.
  - Third expansion-cycle triage closed reopened queue `open=69` -> `open=0` with final totals `resolved=463`, `ignored=412`.
  - Third-pass detail: repeated bounded/full `review-ai` scans initially stalled on cached-open aliases; single-letter GLP shorthand hardening resolved `23`, then manual adjudication ignored the final `44` branded/code aliases.
  - `GLP1-S` / `GLP-1 (S)` aliases now resolve to canonical `semaglutide`.
  - `cagrisema` is currently retained as a tracked canonical blend compound.
- Verified alias triage throughput run:
  - `npm run job:review-ai` completed on `2026-02-15` with `itemsScanned=580`, `resolved=64`, `ignored=0`, `leftOpen=516`, `real=420.01s`.
  - Observed throughput: `82.86 items/min` (`~0.72s/item`), which is faster than the planning estimate (`~1.5s/item`) without code changes.
  - Post-baseline key-enabled burn-down and adjudication closed the queue (`alias_match`: `open=0`, `in_progress=0`, `resolved=383`, `ignored=320`).
- Verified bounded post-rerun triage delta:
  - `npm run job:review-ai -- --limit=25` scanned `14` items and returned `resolved=1`, `ignored=1`, `leftOpen=12` (`durationSeconds=76.56`).
  - Queue delta from rerun baseline (`open=0`, `resolved=383`, `ignored=320`) is now `open +12`, `resolved +1`, `ignored +1`.
  - After classifier fix + reruns, unresolved queue moved to `open=7`, `resolved=384`, `ignored=326` with reason `ai_review_cached`.
  - Final manual adjudication of those 7 items restored queue closure (`open=0`, `in_progress=0`, `resolved=384`, `ignored=333`).
  - A follow-up vendor run (`3178fe72-36db-4335-8fff-1b3fe6ec640a`) completed with `unresolvedAliases=0`, confirming no immediate re-queue.
- Verified manual resolution policy for vendor-exclusive noise:
  - Elite branded one-off formulas plus `Peak Power` and currently single-vendor `MK-777` are intentionally excluded (`ignored`) until/if cross-vendor evidence appears.
- Verified manual-ignore persistence hardening:
  - Ignored review actions now persist admin non-trackable alias memory (`compound_aliases.status='resolved'`, `source='admin'`), reducing repeat queue churn on branded aliases.
- Verified single-vendor exclusion audit bootstrap:
  - Latest report (`reports/exclusion-audit/single-vendor-audit-latest.md`, `2026-02-16T01:01:59Z`) scanned `115` active offers across `50` active compounds.
  - Found `23` single-vendor compounds (`28` offers) and classified all as manual-decision `pending`.
  - No exclusions were enforced automatically; manual confirmation remains required before any rule application.
- Verified manual exclusion enforcement bootstrap:
  - `npm run job:exclusion-enforce` wrote `config/manual-offer-exclusions.json` from the latest audit report.
  - With no approved entries yet, compiled exclusion rule count is `0` (safe no-op).
- Verified ambiguous shorthand and malformed-title cases now resolve correctly:
  - `GLP-1 TZ (10MG)` resolved to `tirzepatide`.
  - `Cag (Cag (5MG))` resolved to `cagrilintide`.
  - `LL-37` vendor `complex` phrasing resolves to canonical `ll-37`.
  - `CJC-1295 &#8211; With DAC (10mg)` resolves to CJC with DAC after HTML-entity cleanup.
